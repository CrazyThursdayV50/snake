# 海龟交易法则 (Turtle Trading System)

## 概述

海龟交易法则是由理查德·丹尼斯（Richard Dennis）和威廉·埃克哈特（William Eckhardt）在20世纪80年代创造的一套完整的趋势跟踪交易系统。它的名称源于一个著名的实验，丹尼斯认为交易技巧可以像教导海龟游泳一样被传授，而不需要天赋。他们招募了一组无交易经验的人（被称为"海龟"），教授他们一套严格的交易规则，而这些"海龟"最终取得了显著的成功。

海龟交易系统是一个完整的机械化交易策略，包含了明确的入场、出场、头寸规模管理和风险控制规则。它主要基于价格突破和趋势跟踪原理，旨在捕捉大趋势而忽略短期噪音。

## 核心算法逻辑

海龟交易系统由以下几个关键组件组成：

### 1. 入场系统

海龟交易系统使用两种不同的入场系统，分别称为系统1和系统2：

**系统1 (短期突破)：**
- 当价格突破20日价格区间的高点时做多
- 当价格突破20日价格区间的低点时做空

**系统2 (长期突破)：**
- 当价格突破55日价格区间的高点时做多
- 当价格突破55日价格区间的低点时做空

在本实现中，我们主要使用系统1作为入场策略。

### 2. 头寸规模计算

海龟交易者使用基于波动性的头寸规模计算方法，称为"波动性归一化"，确保在不同市场和不同时期具有相同的风险水平：

1. 计算价格的真实波动范围（TR）：
   - TR = max(high-low, |high-prev_close|, |low-prev_close|)

2. 计算14日平均真实波动范围（ATR）：
   - ATR = 14日TR的简单移动平均

3. 计算每单位的美元波动性：
   - 美元波动性 = ATR × 合约单位（或USD价值）

4. 计算风险单位数（N）：
   - N = 账户资金 × 风险百分比 ÷ 美元波动性

风险百分比通常设置为总账户资金的0.5%到2%之间。

### 3. 加仓规则

在趋势初始阶段，海龟系统允许在价格继续向有利方向发展时增加头寸：

- 在入场后，如果价格朝有利方向移动0.5个ATR，可以增加一个单位
- 最多可以增加到4个单位（初始仓位加3次）
- 所有头寸共用同一个止损点

### 4. 止损策略

海龟交易系统使用基于ATR的止损方法，而不是基于账户资金百分比的止损：

- 止损位设置在入场价的2个ATR之外
- 多头：止损 = 入场价 - 2×ATR
- 空头：止损 = 入场价 + 2×ATR
- 当加仓时，所有头寸的止损移动到最新入场价的2个ATR之外

### 5. 退出策略

海龟系统有两种退出方法：

**系统1退出：** 当价格突破10日区间的反向突破（比入场区间小）时退出
**系统2退出：** 当价格突破20日区间的反向突破时退出

在本实现中，我们主要使用系统1的退出策略。

## 实现细节

本实现具有以下特点：

1. **唐奇安通道**：使用唐奇安通道（Donchian Channel）计算N日价格区间的高点和低点，用于入场和退出信号
2. **ATR计算**：计算14日平均真实波动范围，用于头寸规模计算和止损点设置
3. **头寸规模管理**：基于账户总值、风险百分比和ATR计算每次交易的头寸大小
4. **加仓逻辑**：在趋势方向上每移动0.5ATR增加一个单位，最多4个单位
5. **止损管理**：设置在入场价的2ATR之外，并随加仓而更新
6. **退出策略**：基于10日反向突破的退出规则

## 参数设置

本实现使用以下默认参数：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `donchianPeriod` | 20 | 唐奇安通道周期（日） |
| `atrPeriod` | 14 | ATR计算周期（日） |
| `riskPercent` | 2.0 | 风险比例（%） |
| `entryUnits` | 4 | 最大入场单元数 |

## 使用方法

```go
import (
    "snake/internal/strategy/turtle"
    "snake/internal/models"
)

// 创建海龟交易法则策略
strategy := turtle.New()

// 初始化策略
err := strategy.Init(decimal.NewFromFloat(1.0), decimal.NewFromFloat(10000.0))

// 使用K线更新策略状态
signal, err := strategy.Update(kline)

// 根据返回的信号执行交易
if signal.Type.IsBuy() {
    // 执行买入操作
} else if signal.Type.IsSell() {
    // 执行卖出操作
}
```

## 实战应用注意事项

1. **趋势市场表现最佳**：海龟交易系统在强趋势市场中表现最佳，在震荡市场中可能产生频繁的亏损交易
2. **心理挑战**：该系统要求严格遵循规则，忽略个人判断，这对许多交易者来说是心理挑战
3. **适合多市场应用**：策略设计适用于多个市场同时交易，分散风险
4. **参数优化**：根据不同市场特性，可以调整入场周期、退出周期和风险比例等参数
5. **资金要求**：由于该策略需要承受一系列小亏损才能捕捉大趋势，建议使用足够大的资金 